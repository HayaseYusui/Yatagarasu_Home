<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="VRChat上で活動するクリエイティブプロジェクト、「公安対魔特務六課八咫烏」の公式HPです。"
    />
    <title>八咫烏 公式HP</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.5.0/semantic.min.css"
      integrity="sha512-KXol4x3sVoO+8ZsWPFI/r5KBVB/ssCGB5tsv2nVOKwLg33wTFP3fmnXa47FdSVIshVTgsYk/1734xSk9aFIa4A=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <script
      src="https://code.jquery.com/jquery-3.1.1.min.js"
      integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.5.0/semantic.min.js"
      integrity="sha512-Xo0Jh8MsOn72LGV8kU5LsclG7SUzJsWGhXbWcYs2MAmChkQzwiW/yTQwdJ8w6UA9C6EVG18GHb/TrYpYCjyAQw=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Sawarabi+Mincho&display=swap"
      rel="stylesheet"
    />
    <link href="./src/stylem.css" rel="stylesheet" />
  </head>

  <body>
    <!-- 読み込み画面 -->
    <div class="loading">
      <div class="img-area">
        <img
          class="ui fluid image blink"
          src="https://i.gyazo.com/ccf6eaf9d096052414e93533d4282de5.png"
        />
      </div>
      <div class="loader"></div>
    </div>
    <!-- 背景動画 -->
    <div id="video-background"></div>
    <!-- 本体 -->
    <div class="video-overlay-bg">
      <!-- Googleサイトリスペクトなヘッダー -->
      <header class="ui vertical center aligned segment">
        <div class="flex justify-center">
          <img
            class="w-full max-w-[1200px] top-logo"
            src="https://lh3.googleusercontent.com/d/1twIoQXJ2xjzy70Wfitncq64UnnXRbslD"
          />
        </div>
        <div class="ui text container">
          <h1 class="ui inverted header font-bold" style="display: none">
            神祇省公安対魔特務六課
          </h1>
          <h4 class="ui horizontal header inverted divider">
            <span class="font-bold">守り抜け、この世界の理を</span>
          </h4>
          <div class="row">
            <div class="sixteen wide column">
              <p>
                当サイトは、VRChat上で活動するクリエイティブプロジェクト、「公安対魔特務六課八咫烏」の公式HPです。
              </p>
            </div>
          </div>
        </div>
      </header>
      <!-- 記事 -->
      <main class="py-8">
        <div class="swiper">
          <!-- Additional required wrapper -->
          <div class="swiper-wrapper">
            <div class="loader-swiper">
              <ul class="hexagon-container">
                <li class="hexagon hex_1"></li>
                <li class="hexagon hex_2"></li>
                <li class="hexagon hex_3"></li>
                <li class="hexagon hex_4"></li>
                <li class="hexagon hex_5"></li>
                <li class="hexagon hex_6"></li>
                <li class="hexagon hex_7"></li>
              </ul>
            </div>
          </div>
          <div id="msg-loading-swiper" class="swiper-caption text-center">
            八咫烏ネットワークに接続中……
          </div>
          <!-- If we need pagination -->
          <div class="swiper-pagination"></div>
        </div>
        <div class="py-8">
          <div class="ui vertical stripe segment">
            <div class="ui text container">
              <h4 class="ui horizontal header inverted divider">
                <span class="font-bold">新着情報</span>
              </h4>
              <h3 class="ui inverted header"></h3>
              <div
                class="ui divided selection list h-[30vh] overflow-auto"
                id="eventList"
              >
                <p>取得中...</p>
              </div>
              <h4 class="ui horizontal header inverted divider">
                <span class="font-bold">「八咫烏」とは</span>
              </h4>
              <div class="row">
                <div class="sixteen wide column">
                  <p>
                    　「公安対魔特務六課八咫烏」とは、2023年5月メタバースプラットフォームVRChatでの活動を目的に発足した、マルチメディアクリエイターコミュニティです。<br />
                    　架空の警察「八咫烏」をテーマに映像・音楽・３Ｄモデルの制作・脚本製作などを通した創作活動を行っています。
                  </p>
                </div>
              </div>
              <h4 class="ui horizontal header inverted divider">
                <span class="font-bold">最新ストーリー公開中！</span>
              </h4>
              <div class="ui middle aligned stackable grid">
                <div class="row">
                  <div class="ten wide column">
                    <h3 class="ui header inverted">「八咫烏追放編」</h3>
                    <p>
                      テロ容疑を掛けられ襲撃される八咫烏。<br />そのとき彼女達は……
                    </p>
                  </div>
                  <div class="six wide right floated column">
                    <img
                      src="https://i.gyazo.com/c01d93e849fa50e9f72b1d6b735444ab.png"
                      class="ui large bordered rounded image"
                    />
                  </div>
                </div>
              </div>
              <h4 class="ui horizontal header inverted divider">
                <span class="font-bold">予定表</span>
              </h4>
              <div class="ui text container">
                <div id="calendar" class="calendar inverted"></div>
              </div>
            </div>
          </div>
        </div>
      </main>
      <!-- Googleサイトリスペクトなフッター -->
      <footer class="ui vertical center aligned segment">
        <div class="ui text container">
          <div class="pt-5">
            <div class="text-center inline-block">
              <a
                href="https://www.google.com/url?q=https%3A%2F%2Fx.com%2Fm_yata_official"
                target="_blank"
                ><img
                  src="https://lh3.googleusercontent.com/pw/AP1GczMsyKVMyHh3K5hm7-SHiEXqVMIezkJgpBxE11PT3mjgPGN2fzmEvwqMxqXn4o36p-JVQzGwY5HR7WJFpU2wJkPKrv12YFsRefG2k6HR9vzHrWUKpNdmYWN0p76T53jC4nL9R-INWk0NN5lZ6Ine55s=w64-h64-s-no-gm?authuser=0"
                  alt="リンク"
                  class="icon"
              /></a>
            </div>
          </div>
          <small>
            <span class="mini-text">
              「公安対魔特務六課
              八咫烏」の物語はフィクションです。実在の人物、団体とは一切関係ございません。<br />
              © 2023 miyabi All Rights Reserved.
            </span>
          </small>
        </div>
      </footer>
      <div class="ui modal">
        <div class="header modal-dark">
          <span id="modalTitle" class="modal-title"></span>
        </div>
        <div class="image content modal-dark">
          <div class="ui medium image">
            <img id="modalImg" src="" />
          </div>
          <div class="description">
            <div class="ui header inverted">イベント時間</div>
            <p id="modalDate"></p>
            <div class="ui header inverted">イベント概要</div>
            <p id="modalDesc"></p>
          </div>
        </div>
        <div class="actions modal-dark">
          <div class="ui red basic cancel inverted button">
            <i class="remove icon"></i>
            閉じる
          </div>
          <div class="ui green ok inverted button" onclick="movePage()">
            <i class="checkmark icon"></i>
            カレンダーを開く
          </div>
        </div>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/google-calendar@6.1.15/index.global.min.js"></script>
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script src="https://unpkg.com/tippy.js@6"></script>
    <script>
      const loading = document.querySelector(".loading");
      window.addEventListener("load", () => {
        setTimeout(() => {
          loading.classList.add("loaded");
        }, 600);
      });

      let eventCalendarId = "";
      let historyCalendarId = "";
      let googleApiKey = "";
      const maxResults = 1000;
      let calendarEventUrl = "";

      function convertUrl(driveUrl) {
        const match = driveUrl.match(/file\/d\/([\w-]+)\/view\?/);
        if (match && match[1]) {
          return `https://lh3.googleusercontent.com/d/${match[1]}`;
        }
        return driveUrl;
      }

      function getRandomElements(arr, count) {
        let shuffled = arr.slice();
        for (let i = shuffled.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
        }
        return shuffled.slice(0, count);
      }

      function formatDate(datetime) {
        const dateObj = new Date(datetime);
        const year = dateObj.getFullYear();
        const month = String(dateObj.getMonth() + 1);
        const day = String(dateObj.getDate());
        const hours = String(dateObj.getHours());
        const minutes = String(
          dateObj.getMinutes().toString().padStart(2, "0")
        );
        const formattedDate = `${year}年${month}月${day}日 ${hours}:${minutes}`;
        return formattedDate;
      }

      function renderEvents(events) {
        const items = [];

        const eventList = document.getElementById("eventList");
        eventList.innerHTML = "";

        events.forEach((event) => {
          const summary = event.summary || "";
          const description = event.description || "";
          const color = summary === "イベント" ? "yellow" : "teal";
          items.push({
            label: summary,
            labelClass: color,
            desc: description,
            date: event.start.date,
            link: undefined,
          });
        });

        const listContainer = document.querySelector(
          ".ui.divided.selection.list"
        );
        items.forEach((item) => {
          const itemElement = document.createElement("a");
          itemElement.className = "item";
          if (item.link) {
            itemElement.href = item.link;
            itemElement.target = "_blank";
            itemElement.rel = "noopener noreferrer";
          }

          const gridDiv = document.createElement("div");
          gridDiv.className = "grid grid-cols-8";

          const labelDiv = document.createElement("div");
          labelDiv.className = "row-span-2 content-center col-span-2";
          const label = document.createElement("div");
          label.className = `ui ${item.labelClass} horizontal label w-11/12`;
          label.textContent = item.label;
          labelDiv.appendChild(label);

          const descDiv = document.createElement("div");
          descDiv.className = "col-span-6";
          const header = document.createElement("h4");
          header.className = "ui header text-yata";
          header.textContent = item.desc;
          descDiv.appendChild(header);

          const spaceDiv = document.createElement("div");
          spaceDiv.className = "col-span-3";

          const dateDiv = document.createElement("div");
          dateDiv.className = "text-yata col-span-3 text-right";
          dateDiv.textContent = item.date;

          gridDiv.appendChild(labelDiv);
          gridDiv.appendChild(descDiv);
          gridDiv.appendChild(spaceDiv);
          gridDiv.appendChild(dateDiv);

          itemElement.appendChild(gridDiv);
          listContainer.appendChild(itemElement);
        });
      }

      function isJPG(url) {
        return (
          url.toLowerCase().endsWith(".jpg") ||
          url.toLowerCase().endsWith(".jpeg")
        );
      }

      function movePage() {
        window.open(calendarEventUrl, "_blank", "noreferrer");
      }

      async function loadDatabase() {
        const response = await fetch(
          "https://script.google.com/macros/s/AKfycbwNxpIkWmwe4Th9dpVEOY3foF4FVQVZQx93zJZNE0-SF_nnQS2Nka9qYfJk85FJ2vxK/exec"
        );
        const data = await response.json();

        if (data) {
          // ▼ 追加部分：APIキーなどを代入
          googleApiKey = data.googleApiKey;
          eventCalendarId = data.eventCalendarId;
          historyCalendarId = data.historyCalendarId;

          // ▼ スライド画像の処理
          initializeSwiper(data);

          // ▼ カレンダーを初期化
          initializeCalendar();

          // ▼ 過去イベント取得
          fetchCalendarEvents();

          // ▼ YouTube 動画再生設定の再読み込み
          setupYouTubeBackground(data.videoId);
        }
      }

      function initializeSwiper(data) {
        const listContainer = document.querySelector(".swiper-wrapper");
        listContainer.replaceChildren();
        document.getElementById("msg-loading-swiper").remove();

        getRandomElements(data.images || [], 10).forEach((imgUrl) => {
          const divElement = document.createElement("div");
          divElement.className = "swiper-slide";

          const imageElement = document.createElement("img");
          imageElement.className = "ui fluid image";
          imageElement.src = convertUrl(imgUrl);

          divElement.appendChild(imageElement);
          listContainer.appendChild(divElement);
        });

        new Swiper(".swiper", {
          loop: true,
          centeredSlides: true,
          pagination: {
            el: ".swiper-pagination",
            dynamicBullets: true,
          },
          autoplay: {
            delay: 2500,
            disableOnInteraction: false,
          },
          grabCursor: true,
          effect: "cards",
        });
      }

      function initializeCalendar() {
        let calendarEl = document.getElementById("calendar");
        let calendar = new FullCalendar.Calendar(calendarEl, {
          googleCalendarApiKey: googleApiKey,
          eventSources: [
            {
              googleCalendarId: eventCalendarId,
              backgroundColor: "#000",
              textColor: "#fff",
              borderColor: "black",
            },
            {
              googleCalendarId:
                "ja.japanese#holiday@group.v.calendar.google.com",
              className: "event_holiday",
            },
          ],
          initialView: "dayGridMonth",
          locale: "ja",
          editable: false,
          navLinks: false,
          aspectRatio: 2,
          headerToolbar: {
            right: "prev,next",
          },
          contentHeight: "auto",
          dayCellContent: function (e) {
            e.dayNumberText = e.dayNumberText.replace("日", "");
            return e.dayNumberText;
          },
          displayEventTime: false,
          eventTimeFormat: { hour: "numeric", minute: "2-digit" },
          eventClick: function (info) {
            info.jsEvent.preventDefault(); // don't let the browser navigate
            document.getElementById("modalTitle").innerHTML = info.event.title;
            if (info.event.start) {
              const date = `${formatDate(info.event.start)} ～ ${formatDate(
                info.event.end
              )}`;
              document.getElementById("modalDate").innerHTML = date;
            }
            if (info.event.extendedProps.description) {
              let detail = info.event.extendedProps.description.replace(
                "<a ",
                '<a target="_blank" '
              );

              const gyazoLinkRegex =
                /<a[^>]*href=["'](https?:\/\/i\.gyazo\.com\/[a-zA-Z0-9]+\.jpg|\.png)["'][^>]*>.*?<\/a>/gi;
              const gyazoMatch = detail.match(gyazoLinkRegex);
              if (gyazoMatch) {
                const imgUrlMatch = gyazoMatch[0].match(
                  /https?:\/\/i\.gyazo\.com\/[a-zA-Z0-9]+\.jpg|\.png/
                );
                if (imgUrlMatch) {
                  document.getElementById("modalImg").src = imgUrlMatch[0];
                }
                detail = detail.replace(gyazoLinkRegex, "").trim();
              } else {
                document.getElementById("modalImg").src =
                  "https://i.gyazo.com/ccf6eaf9d096052414e93533d4282de5.png";
              }
              document.getElementById("modalDesc").innerHTML = detail;
            }
            calendarEventUrl = info.event.url;
            $(".ui.modal").modal("show");
          },
        });
        calendar.render();
      }

      async function fetchCalendarEvents() {
        if (!historyCalendarId || !googleApiKey) return;

        const url = `https://www.googleapis.com/calendar/v3/calendars/${historyCalendarId}/events?key=${googleApiKey}&maxResults=${maxResults}&orderBy=startTime&singleEvents=true`;

        try {
          const response = await fetch(url);
          const data = await response.json();
          if (data.items) {
            renderEvents(data.items.reverse());
          } else {
            document.getElementById("eventList").innerHTML =
              "<p>イベントが見つかりません。</p>";
          }
        } catch (error) {
          document.getElementById("eventList").innerHTML =
            "<p>イベントを取得できませんでした。</p>";
        }
      }

      let ytPlayer;
      function setupYouTubeBackground(videoId) {
        if (!videoId) return;
        if (ytPlayer) {
          ytPlayer.loadVideoById(videoId);
          return;
        }

        // 動的にiframeAPI読み込み
        let tag = document.createElement("script");
        tag.src = "https://www.youtube.com/iframe_api";
        let firstScriptTag = document.getElementsByTagName("script")[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        window.onYouTubeIframeAPIReady = () => {
          ytPlayer = new YT.Player("video-background", {
            videoId: videoId,
            playerVars: {
              autoplay: 1,
              controls: 0,
              disablekb: 1,
              fs: 0,
              iv_load_policy: 3,
              loop: 1,
              modestbranding: 1,
              rel: 0,
              wmode: "transparent",
              playsinline: 1,
            },
            events: {
              onReady: onPlayerReady,
              onStateChange: onPlayerStateChange,
            },
          });
        };
      }

      function onPlayerReady(e) {
        ytPlayer.mute();
        ytPlayer.playVideo();
        ytPlayer.setPlaybackQuality("default");
      }

      function onPlayerStateChange(e) {
        switch (e.data) {
          case YT.PlayerState.ENDED:
            e.target.playVideo();
            break;
        }
      }

      let WIN = $(window);
      let WIN_H;
      let WIN_W;

      function yt_screen_retio() {
        WIN_H = WIN.height();
        WIN_W = WIN.width();
        let screen_switch = 0.5625;
        let screen_ratio = WIN_H / WIN_W;
        let ratio_H = WIN_H / screen_switch;
        let ratio_W = WIN_W * screen_switch;

        if (screen_ratio > screen_switch) {
          $("#video-background").css({
            height: "100%",
            width: ratio_H,
            "margin-top": "0",
            "margin-left": -ratio_H / 2,
            left: "50%",
            top: "0",
          });
        } else {
          $("#video-background").css({
            width: "100%",
            height: ratio_W,
            "margin-top": -ratio_W / 2,
            "margin-left": "0",
            top: "50%",
            left: "0",
          });
        }
      }

      WIN.resize(function () {
        yt_screen_retio();
      });

      loadDatabase();
      yt_screen_retio();
    </script>
  </body>
</html>
